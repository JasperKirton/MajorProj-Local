This is essentially all the back-end code.